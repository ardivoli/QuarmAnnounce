# Multi-Platform Release Build Workflow
# This workflow builds the quarm_announce application for Windows and Linux platforms,
# packages the binaries with required dependencies, and creates a GitHub release.

name: Multi-Platform Release Build

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write
  actions: read

env:
  CARGO_TERM_COLOR: always

jobs:
  validate-version:
    name: Validate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract and validate version
        id: version
        run: |
          # Extract version from git tag (e.g., v1.2.3 -> 1.2.3)
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          echo "Tag version: $TAG_VERSION"

          # Extract version from Cargo.toml
          CARGO_VERSION=$(cargo metadata --format-version 1 --no-deps | jq -r '.packages[0].version')
          echo "Cargo.toml version: $CARGO_VERSION"

          # Compare versions
          if [ "$TAG_VERSION" != "$CARGO_VERSION" ]; then
            echo "::error::Version mismatch! Git tag is v$TAG_VERSION but Cargo.toml has version $CARGO_VERSION"
            echo "::error::Please update Cargo.toml version to $TAG_VERSION before creating this release"
            exit 1
          fi

          echo "✓ Version validation passed: $TAG_VERSION"
          echo "version=$TAG_VERSION" >> $GITHUB_OUTPUT

  build-windows:
    name: Build Windows Binary
    runs-on: windows-latest
    needs: validate-version
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Verify Git LFS files
        shell: bash
        run: |
          # Check if ONNX model exists
          if [ ! -f resources/speakers/en_US-amy-medium.onnx ]; then
            echo "::error::ONNX model file not found at resources/speakers/en_US-amy-medium.onnx"
            exit 1
          fi

          # Get file size (cross-platform: use PowerShell on Windows via bash)
          SIZE=$(powershell -Command "(Get-Item resources/speakers/en_US-amy-medium.onnx).Length")
          echo "ONNX model size: $SIZE bytes"

          # Verify file is at least 60MB (not an LFS pointer)
          if [ $SIZE -lt 60000000 ]; then
            echo "::error::ONNX model file is too small ($SIZE bytes). Expected at least 60MB. This may be an LFS pointer file."
            echo "::error::Ensure Git LFS is properly configured and the model was downloaded."
            exit 1
          fi

          echo "✓ LFS files verified: ONNX model is $SIZE bytes"

          # Also verify JSON config exists
          if [ ! -f resources/speakers/en_US-amy-medium.onnx.json ]; then
            echo "::error::ONNX model config not found at resources/speakers/en_US-amy-medium.onnx.json"
            exit 1
          fi

          echo "✓ ONNX model config verified"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install frontend dependencies
        run: pnpm install

      - name: Run unit tests
        run: cargo test --verbose

      - name: Build Tauri application
        run: pnpm tauri:build --verbose

      - name: Verify binary exists
        shell: bash
        run: |
          if [ ! -f target/release/quarm_announce.exe ]; then
            echo "::error::Windows binary not found at target/release/quarm_announce.exe"
            exit 1
          fi
          echo "✓ Windows binary built successfully"

      - name: Smoke test binary
        shell: bash
        run: |
          # Check if binary is executable
          if [ -f target/release/quarm_announce.exe ]; then
            echo "✓ Binary exists and is accessible"
          else
            echo "::error::Binary smoke test failed"
            exit 1
          fi

      - name: Upload Windows binary
        uses: actions/upload-artifact@v4
        with:
          name: windows-binary
          path: target/release/quarm_announce.exe
          if-no-files-found: error

      - name: Locate espeak-ng-data from build
        id: espeak-data-win
        shell: bash
        run: |
          # Find the espeak-ng-data directory in the build output
          ESPEAK_DATA_DIR=$(find target/release/build -type d -name "espeak-ng-data" -path "*/share/*" | head -1)
          if [ -z "$ESPEAK_DATA_DIR" ]; then
            echo "::error::Could not find espeak-ng-data in build output"
            exit 1
          fi
          echo "Found espeak-ng-data at: $ESPEAK_DATA_DIR"
          echo "espeak_data_dir=$ESPEAK_DATA_DIR" >> $GITHUB_OUTPUT

      - name: Upload espeak-ng-data (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: windows-espeak-data
          path: ${{ steps.espeak-data-win.outputs.espeak_data_dir }}
          if-no-files-found: error

  build-linux:
    name: Build Linux Binary
    runs-on: ubuntu-latest
    needs: validate-version
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Verify Git LFS files
        run: |
          # Check if ONNX model exists
          if [ ! -f resources/speakers/en_US-amy-medium.onnx ]; then
            echo "::error::ONNX model file not found at resources/speakers/en_US-amy-medium.onnx"
            exit 1
          fi

          # Get file size using stat
          SIZE=$(stat -c%s resources/speakers/en_US-amy-medium.onnx)
          echo "ONNX model size: $SIZE bytes"

          # Verify file is at least 60MB (not an LFS pointer)
          if [ $SIZE -lt 60000000 ]; then
            echo "::error::ONNX model file is too small ($SIZE bytes). Expected at least 60MB. This may be an LFS pointer file."
            echo "::error::Ensure Git LFS is properly configured and the model was downloaded."
            exit 1
          fi

          echo "✓ LFS files verified: ONNX model is $SIZE bytes"

          # Also verify JSON config exists
          if [ ! -f resources/speakers/en_US-amy-medium.onnx.json ]; then
            echo "::error::ONNX model config not found at resources/speakers/en_US-amy-medium.onnx.json"
            exit 1
          fi

          echo "✓ ONNX model config verified"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libasound2-dev \
            libgtk-3-dev libwebkit2gtk-4.1-dev librsvg2-dev
          # Note: SteamOS may require additional packages (glibc, make)
          # This is a known limitation documented in the PRD

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install frontend dependencies
        run: pnpm install

      - name: Run unit tests
        run: cargo test --verbose

      - name: Build Tauri application
        run: pnpm tauri:build --verbose

      - name: Verify binary exists
        run: |
          if [ ! -f target/release/quarm_announce ]; then
            echo "::error::Linux binary not found at target/release/quarm_announce"
            exit 1
          fi
          echo "✓ Linux binary built successfully"

      - name: Verify binary format
        run: |
          file target/release/quarm_announce
          if file target/release/quarm_announce | grep -q "ELF 64-bit"; then
            echo "✓ Binary is correct ELF 64-bit format"
          else
            echo "::error::Binary is not in expected ELF 64-bit format"
            exit 1
          fi

      - name: Smoke test binary
        run: |
          # Verify binary is executable and can be accessed
          if [ -x target/release/quarm_announce ]; then
            echo "✓ Binary is executable"
          else
            echo "::error::Binary is not executable"
            exit 1
          fi

      - name: Upload Linux binary
        uses: actions/upload-artifact@v4
        with:
          name: linux-binary
          path: target/release/quarm_announce
          if-no-files-found: error

      - name: Locate espeak-ng-data from build
        id: espeak-data-linux
        run: |
          # Find the espeak-ng-data directory in the build output
          ESPEAK_DATA_DIR=$(find target/release/build -type d -name "espeak-ng-data" -path "*/share/*" | head -1)
          if [ -z "$ESPEAK_DATA_DIR" ]; then
            echo "::error::Could not find espeak-ng-data in build output"
            exit 1
          fi
          echo "Found espeak-ng-data at: $ESPEAK_DATA_DIR"
          echo "espeak_data_dir=$ESPEAK_DATA_DIR" >> $GITHUB_OUTPUT

      - name: Upload espeak-ng-data (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: linux-espeak-data
          path: ${{ steps.espeak-data-linux.outputs.espeak_data_dir }}
          if-no-files-found: error

  package-artifacts:
    name: Package Release Artifacts
    runs-on: ubuntu-latest
    needs: [validate-version, build-windows, build-linux]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Download Windows binary
        uses: actions/download-artifact@v4
        with:
          name: windows-binary
          path: ./artifacts/windows/

      - name: Download Linux binary
        uses: actions/download-artifact@v4
        with:
          name: linux-binary
          path: ./artifacts/linux/

      - name: Download Windows espeak-ng-data
        uses: actions/download-artifact@v4
        with:
          name: windows-espeak-data
          path: ./artifacts/windows-espeak-data/

      - name: Download Linux espeak-ng-data
        uses: actions/download-artifact@v4
        with:
          name: linux-espeak-data
          path: ./artifacts/linux-espeak-data/

      - name: Display artifact structure
        run: |
          echo "Downloaded artifacts:"
          ls -la artifacts/
          echo "Windows artifacts:"
          ls -la artifacts/windows/
          echo "Linux artifacts:"
          ls -la artifacts/linux/

      - name: Create Windows staging directory
        run: |
          mkdir -p staging-windows
          cp artifacts/windows/quarm_announce.exe staging-windows/
          cp config.json staging-windows/
          cp -r resources/speakers staging-windows/
          cp -r artifacts/windows-espeak-data staging-windows/espeak-ng-data
          echo "Windows staging directory contents:"
          ls -la staging-windows/
          ls -la staging-windows/speakers/
          ls -la staging-windows/espeak-ng-data/ | head -10

      - name: Create Windows package
        run: |
          cd staging-windows
          zip -r ../quarm_announce-v${{ needs.validate-version.outputs.version }}-windows-x64.zip .
          cd ..
          echo "Created Windows package:"
          ls -lh quarm_announce-v${{ needs.validate-version.outputs.version }}-windows-x64.zip

      - name: Upload Windows package
        uses: actions/upload-artifact@v4
        with:
          name: windows-package
          path: quarm_announce-v${{ needs.validate-version.outputs.version }}-windows-x64.zip
          if-no-files-found: error

      - name: Create Linux staging directory
        run: |
          mkdir -p staging-linux
          cp artifacts/linux/quarm_announce staging-linux/
          chmod +x staging-linux/quarm_announce
          cp config.json staging-linux/
          cp -r resources/speakers staging-linux/
          cp -r artifacts/linux-espeak-data staging-linux/espeak-ng-data
          echo "Linux staging directory contents:"
          ls -la staging-linux/
          ls -la staging-linux/speakers/
          ls -la staging-linux/espeak-ng-data/ | head -10

      - name: Create Linux package
        run: |
          tar -czf quarm_announce-v${{ needs.validate-version.outputs.version }}-linux-x64.tar.gz -C staging-linux .
          echo "Created Linux package:"
          ls -lh quarm_announce-v${{ needs.validate-version.outputs.version }}-linux-x64.tar.gz

      - name: Upload Linux package
        uses: actions/upload-artifact@v4
        with:
          name: linux-package
          path: quarm_announce-v${{ needs.validate-version.outputs.version }}-linux-x64.tar.gz
          if-no-files-found: error

      - name: Verify package contents
        run: |
          echo "=== Verifying Windows package ==="
          unzip -l quarm_announce-v${{ needs.validate-version.outputs.version }}-windows-x64.zip

          # Verify espeak-ng-data is included
          if ! unzip -l quarm_announce-v${{ needs.validate-version.outputs.version }}-windows-x64.zip | grep -q "espeak-ng-data/"; then
            echo "::error::Windows package missing espeak-ng-data directory"
            exit 1
          fi
          echo "✓ Windows package contains espeak-ng-data"

          echo -e "\n=== Verifying Linux package ==="
          tar -tzf quarm_announce-v${{ needs.validate-version.outputs.version }}-linux-x64.tar.gz

          # Verify espeak-ng-data is included
          if ! tar -tzf quarm_announce-v${{ needs.validate-version.outputs.version }}-linux-x64.tar.gz | grep -q "espeak-ng-data/"; then
            echo "::error::Linux package missing espeak-ng-data directory"
            exit 1
          fi
          echo "✓ Linux package contains espeak-ng-data"

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate-version, package-artifacts]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate changelog
        id: changelog
        uses: actions/github-script@v7
        env:
          TAG_NAME: ${{ github.ref_name }}
        with:
          script: |
            const release = await github.rest.repos.generateReleaseNotes({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: process.env.TAG_NAME
            });
            return release.data.body;
          result-encoding: string

      - name: Save changelog to file
        run: |
          echo "${{ steps.changelog.outputs.result }}" > changelog.md

      - name: Display changelog preview
        run: |
          echo "=== Generated Changelog ==="
          cat changelog.md

      - name: Download Windows package
        uses: actions/download-artifact@v4
        with:
          name: windows-package
          path: ./release-artifacts/

      - name: Download Linux package
        uses: actions/download-artifact@v4
        with:
          name: linux-package
          path: ./release-artifacts/

      - name: Display release artifacts
        run: |
          echo "Release artifacts:"
          ls -lh ./release-artifacts/

      - name: Create draft release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          draft: true
          name: ${{ github.ref_name }}
          body_path: changelog.md
          files: |
            ./release-artifacts/*.zip
            ./release-artifacts/*.tar.gz
